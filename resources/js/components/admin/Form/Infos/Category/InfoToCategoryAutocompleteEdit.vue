<template>
  <div class="form-group">
    <label class="col-sm-2 control-label" for="input-parent-category-name">
      <span data-toggle="tooltip" data-original-title="(Tự động hoàn toàn)">{{
        $options.setting.paren_category_txt
      }}</span>
    </label>
    <div class="col-sm-10" id="cms-scroll-dropdown">
      <input
        autocomplete="off"
        v-on:focus="_focusParentCategory"
        v-on:keyup.enter="_searchProducts()"
        v-model="query"
        type="text"
        name="category"
        :placeholder="$options.setting.paren_category_txt"
        id="input-parent-category-name"
        class="form-control"
      />
      <span class="btn btn-default cms-btn-input-right" @click="_closeDropdown">
        <i class="fa fa-times fa-fw"></i>
      </span>
      <ul class="dropdown-menu cms-ul-cate-dropdown" :style="dropdownStyle">
        <the-dropdown-category
          :key="-1"
          :category="itemNone"
        ></the-dropdown-category>

        <the-dropdown-category
          v-for="(item, idx) in dropdowns"
          :key="idx"
          :category="item"
        ></the-dropdown-category>
      </ul>

      <div
        v-if="categorys.length"
        key="category-result-list"
        class="well well-sm"
        style="height: 150px; overflow: auto"
      >
        <category-item
          v-for="(item, idx) in categorys"
          :key="idx"
          :info-to-category="item"
        ></category-item>
      </div>
      <div
        v-else
        key="category-result-empty"
        class="well well-sm"
        style="height: 150px; overflow: auto"
      ></div>
    </div>
  </div>
</template>

<script>
import { mapState, mapGetters, mapActions, } from 'vuex'
import TheDropdownCategory from './DropdownInfoToCategoryAutocomplete'
import CategoryItem from './CategoryItemEdit'
import {
  MODULE_NEWS_CATEGORY,
  MODULE_NEWS_CATEGORY_EDIT,
  MODULE_INFO_EDIT,
} from 'store@admin/types/module-types'
import {
  ACTION_GET_DROPDOWN_CATEGORY_LIST,
  ACTION_ADD_INFO_TO_CATEGORY_LIST,
} from 'store@admin/types/action-types'

export default {
  name: 'CategoryEditAutocompleteEdit',
  components: {
    TheDropdownCategory,
    CategoryItem,
  },
  props: {
    categoryId: {
      default: null,
    },
  },
  data() {
    return {
      dropdownStyle: 'display: none;',
      itemNone: {
        category_id: -1,
        name: ' --- Chọn --- ',
        sort_order: 0,
      },
      query: '',
    }
  },
  computed: {
    ...mapGetters(MODULE_NEWS_CATEGORY_EDIT, ['infoCategory', 'getNameQuery']),
    ...mapState(MODULE_INFO_EDIT, {
      categorys: (state) => state.listCategorysDisplay,
    }),
    ...mapState(MODULE_NEWS_CATEGORY, {
      dropdowns: (state) => state.dropdownCategories,
    }),
  },
  watch: {
    query: {
      handler: _.debounce(() => {
        this._searchCategories()
      }, 100),
    },
    infoCategory: {
      handler: function(val) {
        this._addInfoToCategory(val)
      },
    },
  },
  methods: {
    ...mapActions(MODULE_NEWS_CATEGORY, [ACTION_GET_DROPDOWN_CATEGORY_LIST]),
    ...mapActions(MODULE_INFO_EDIT, [ACTION_ADD_INFO_TO_CATEGORY_LIST]),
    _searchCategories() {
      const query = this.query?.length
      if (query && (parseInt(query) > 0)) {
        this[ACTION_GET_DROPDOWN_CATEGORY_LIST](query)
      }
    },
    _focusParentCategory() {
      const query = this.query
      this[ACTION_GET_DROPDOWN_CATEGORY_LIST](query)
      this.$data.dropdownStyle = this.$options.setting.cssDisplay
    },
    _closeDropdown() {
      this.$data.dropdownStyle = this.$options.setting.cssDisplayNone
    },
    _addInfoToCategory(category) {
      const cate = this.$deep(category)
      this[ACTION_ADD_INFO_TO_CATEGORY_LIST](cate)
    },
  },
  setting: {
    cssDisplay: 'display:block',
    cssDisplayNone: 'display:none',
    paren_category_txt: 'Danh mục tin tức cha',
  },
}
</script>

<style type="text/css" lang="css" scoped>
.cms-ul-cate-dropdown {
  top: 35px;
  left: 15px;
}
.cms-ul-cate-dropdown > li > a:hover,
.cms-dropdown-menu > li > a:focus {
  background-color: green !important;
}
.cms-btn-dropdown {
  position: absolute;
  right: 0px;
  top: 0px;
  font-size: 0.5em;
}
</style>
